### Brokered Order Items Feed HotWax to NetSuite

### Sample CSV schema of Brokered Order Items Feed For NetSuite
| Line Id | External Id | Item  | Closed | Quantity | Location |
|---------|-------------|-------|--------|----------|----------|
| 1       | KR16360     | 28198 |        |          | 114      |
| 5       | KR16360     | 28198 |        |          | 114      |


### Requirement

Streamline the process of transferring the brokered order items from HotWax to NetSuite by introducing an automated system for preparing the CSV file format with the required details of the brokered order items.

### Design and Decisions
1. First, the Brokered Order Items Feed HotWax JSON will be generated using Moqui, and it will be kept on the SFTP.
2. Using NiFi, the file will be read and transformed into the required format of NetSuite.
3. From HotWax only those orders will be sent to NetSuite, that are brokered to the facilities where NetSuite manages fulfillment, it can be physical stores or warehouses.
4. NetSuite has certain warehouses which are used for fulfillment, it may not be true that all the facilities are being used for fulfillment, it may have certain facilities that will be used for fulfillment at NetSuite.
5. To address the issue in HotWax such facilities will be grouped together and a Facility Group is created for NetSuite.
6. On the basis on the NetSuite facility group the orders will be filtered in the transformation.

### Implementation Flow

1. Moqui:
    1. A scheduled service job will automatically fetch eligible records and prepare the JSON file format of Brokered Order Items Feed.
    2. This initial feed will include all order items, whether the order items are brokered on stores or warehouses.
    3. The prepared file of Brokered Order Items feed will be kept on the SFTP location.

2. NiFi:
    1. NiFi will read the Brokered Order Items Feed file generated by Moqui from the SFTP location, will apply the required transformations
       and exclude those order items that are not the part of the facility group which is created for NetSuite.
    2. In the further process NiFi will convert the data from JSON format to CSV format and keep the file on the SFTP location for NetSuite consumption.


### NiFi Flow
1. This NiFi flow automates the handling to prepare and send the Brokered Order Items Feed from HotWax to NetSuite.
   It utilizes a sequence of processors to seamlessly manage data preparation and conversions for the Brokered Order Items Feed.
    1. **ListSFTP**
        1. The ListSFTP processor is configured to read and process the Moqui generated Brokered Order Items JSON feed file from the SFTP location.

    2. **FetchSFTP**
        1. The FetchSFTP processor will move the Moqui generated Brokered Order Items Feed file into the archive folder, this needed to manage the files that are processed by NiFi.

    3. **JoltTransformJSON**
        1. The JoltTransformJSON processor is used to transform the HC generated Brokered Order Items feed JSON into the
           required JSON format of Brokered Order Items Feed.

    4. **ConvertRecord**
        1. The ConvertRecord processor is used to convert the Brokered Order Items Feed file format into the CSV file format.

    5. **UpdateAttribute**
        1. The UpdateAttribute processor is used to update the file name of Brokered Order Items Feed CSV file format.

    6. **PutSFTP**
        1. The PutSFTP processor is used to put the Brokered Order Items Feed CSV file at the SFTP.


### Mapping of the Brokered Order Items Feed for NetSuite File format

| NetSuite Field Name | Type    | Description    | HC Brokered Order Items Feed Mapping |
|---------------------|---------|----------------|----------------------|
| Line Id             | String  | The NetSuite line Id of the order item. | orderItemAttributes.attrValue |
| External Id         | String  | HotWax order ID as a external id for NetSuite, since HotWax is an external system for NetSuite. | orderItems.orderId   |
| Item                | String  | The product identifier for the order item. | goodIdentifications.idValue </br> **NOTE:** goodIdentifications[n].goodIdentificationTypeId value should be **NETSUITE_PRODUCT_ID** |
| Closed              | Boolean | Closed         | Default value, set to empty |
| Quantity            | Number  | The quantity of the order item. | Default value, set to empty |
