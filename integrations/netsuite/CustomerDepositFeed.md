## Customer Deposit Feed HotWax to NetSuite

### JSON Schema for Customer Deposit Feed for NetSuite
```json
[ {
  "order_id" : "10567845",
  "total_amount" : "693.00",
  "payment_method" : "8",
  "shopify_order_no" : "361675"
}, {
  "order_id" : "10568645",
  "total_amount" : "290.00",
  "payment_method" : "8",
  "shopify_order_no" : "361676"
}]
```

### FTP locations
#### Path for NetSuite to consume the Customer Deposit Feed
```text
/home/${sftp-username}/netsuite/salesorder/customerdeposit
```

#### Path for OMS for the log file 

This path represents the sftp location where the Customer Deposit Feed is kept for logging purpose.
```text
/home/${sftp-username}/nifi-feed-logs/netsuite/customerdeposit
```

### Sample Feed File Name Format
```text
${clientName}_CustomerDepositFeed_2024-01-07-22_22_00_087.json
```

### Requirement
1. Prepare Customer Deposit Feed JSON from HotWax to NetSuite.
2. The Customer Deposit Feed contains the information about order, its total amount and a code for the payment method.
3. The data for the feed should be fetched incrementally i.e. an order once sent should not be sent in the subsequent feeds.

### Implementation flow
1. The feed will be generated using a SQL to fetch data from OMS. The feed will be generated in JSON format.
2. For Customer Deposit Feed, the orders needs to be fetched incrementally i.e. the same order should not be sent in the subsequent feeds.
3. The fromDate column of OrderIdentification is used for fetching orders incrementally.
4. The generated feed file is put to SFTP.

### NiFi Flow
The below processors are used to prepare the NiFi Flow

1. QueryDatabaseTableRecord
    1. The QueryDatabaseTableRecord processor is used to execute the SQL on HC database and incrementally fetch the data.

2. UpdateAttribute
    1. The UpdateAttribute processor is used to update the file name of the feed file generated by QueryDatabaseTableRecord processor.

3. PutSFTP
    1. The PutSFTP processor is used to put the Customer Deposit Feed file to the SFTP location.

### Field Mapping
Following fields are prepared in the feed

| Fields           | Data Type | Description                            | HC Field Mapping                                                                                                        |
|------------------|-----------|----------------------------------------|-------------------------------------------------------------------------------------------------------------------------|
| order_id         | String    | The unique identification of the order | OrderIdentification.id_value where order_identification_type_id = 'NETSUITE_ORDER_ID'                                   |
| total_amount     | String    | The total amount of the order          | OrderHeader.grand_total                                                                                                 |
| payment_method   | String    | The payment method for the order       | IntegrationTypeMapping.mapping_value where integration_type_id = 'NETSUITE_PMT_MTHD'                                    |
| shopify_order_no | String    | The shopify order name of the order    | OrderIdentification.id_value where order_identification_type_id = 'SHOPIFY_ORDER_NAME'|